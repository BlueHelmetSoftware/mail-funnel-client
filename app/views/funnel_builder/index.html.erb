<% content_for :javascript do %>
		<script type="text/javascript">
			window.mainPageTitle = 'Main Page';
			ShopifyApp.ready(function () {
				ShopifyApp.Bar.initialize({
					title: window.mainPageTitle,
					icon: '/shopify.png',
					buttons: {
						secondary: {
							label: "Mail-Funnel Home",
							href: "http://docs.shopify.com/embedded-app-sdk",
							target: 'new'
						}
					}
				});
			});
		</script>
<% end %>

<nav class="navbar navbar-default">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="<%= root_url %>">Mail Funnel</a>
		</div>
		
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li><a href="<%= root_url %>">Home <span class="sr-only">(current)</span></a></li>
				<li class="active"><a href="<%= funnel_path %>">Mail-Funnel-Builder</a></li>
				<li><a href="<%= root_url %>lists">Email Lists</a></li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<!--<li><a href="#">Link</a></li>-->
			</ul>
		</div>
	</div>
</nav>

<!--<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">-->

<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"-->
<!--integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">-->

<div class="container">
	<h2>Mail Funnel Builder</h2>
	
	<div class="row">
		<div class="col-xs-12 col-sm-6 pull-right">
			<div class="well">
				<div clas="col-xs-12">
					<h5><b>Campaign: </b><%= @campaign.name %></h5>
					<h5><b>Hook: </b><%= @hook.name %></h5>
					<h5><b>Email-List: </b><%= @email_list.name %></h5>
				</div>
			</div>
			<hr>
			<label>Job Actions</label><br>
			<div class="form-horizontal">
				<div class="row text-center">
					<div class="form-group">
						<div class="col-xs-10 text-center">
							<button class="btn btn-primary" id="create_button">New Job</button>
							<button class="btn btn-danger" style="" id="delete_selected_button">Delete Selected Job</button>
							<button class="btn btn-success" style="" id="edit_selected_button">Edit Selected Job</button>
						</div>
					</div>
				</div>
			</div>
			<hr>
			<div class="well">
				<label>Campaign Email List</label>
				<%= render 'main_interface/email_list_select' %>
			</div>
		</div>
		
		<div class="col-xs-12 col-sm-6" id="funnel-builder-canvas"></div>
	</div>
</div>

</div>

<script type="text/javascript">
	$('#ajax-messages').on('ajax:error', function (event, xhr, status, error) {
		// TODO: SECURITY - Aadd Token here for secure ajax calls + add before_filter to controller
		ShopifyApp.flashError(xhr.responseText);
		$(this).append(xhr.responseText)
	});
	
	
	//	INDEX NODES
	$(document).ready(function () {
		var csrf_token = $('meta[name=csrf-token]').attr('content');
		var csrf_param = $('meta[name=csrf-param]').attr('content');
		// TODO: clean up this useless auth code + figure out which ones are being used
		$.ajaxSetup({
			headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')}
		});
		
		console.log("CSRF Token / CSRF Param");
		console.log(csrf_token);
		console.log(csrf_param);
		
		var docWidth = $(document).width();
		
		$.ajax.bind("ajaxSend", function (elm, xhr, s) {
			if(s.type == "POST") {
				xhr.setRequestHeader('X-CSRF-Token', csrf_token);
			}
		});
		
		var $canvas = $('#funnel-builder-canvas');
		
		var windowHeight = $(window).height();   // Browser Viewport Height
		var docHeight = $(document).height(); // HTML Doc height
		
		var height = window.innerHeight;
		
		$canvas.height(<%= @height %>);
//		$canvas.width($(document).height() / 4);
		
		function populateModal(response) {
			console.log(response['name']);
			
			console.log(response);
			
			$('#node_update_job_id').val(response['job_id']);
			$('#node_update_job_name').val(response['name']);
			
			$('#node_update_email_list_id').val(response['email_list_id']);
			
			$('#node_update_job_subject').val(response['subject']);
			$('#node_update_job_content').val(response['content']);
			
			$('#node_update_hook_identifier').text(response['hook_identifier']);
			
			console.log('executed: ' + response['executed']);
			
			$('#node_update_job_executed').text(response['executed']);
			$('#node_update_job_execute_time').text(response['execute_time']);
			$('#node_update_job_execute_frequency').val(response['execute_frequency']);
			
			$('#node_update_app_id').text(response['app_id']);
			$('#node_update_campaign_id').text(response['client_campaign']);
			$('#node_update_local_identifier').text(response['local_identifier']);
		}
		
		function reloadCanvas() {
			$.ajax.bind("ajaxSend", function (elm, xhr, s) {
				if(s.type == "POST") {
					xhr.setRequestHeader('X-CSRF-Token', csrf_token);
				}
			});
			
			var ajaxCall = $.ajax({
				method: "POST",
				data: {
					width: $(document).width(),
					app_id: <%= @app_id %>,
					campaign_id: <%= @campaign_id %>,
					CSRF: csrf_token,
					authenticity_token: csrf_token
				},
				dataType: "json",
				url: "/fbapi_index",
				cache: false,
				success: function (response) {
					console.log("AJAX Success");
					console.log(response);
					var $canvas = $('#funnel-builder-canvas');
					$canvas.flowchart(response);
				}
			});
		}
		
		reloadCanvas();
	});
	
	// UPDATE NODE
	$('#edit_selected_button').click(function (event) {
		var nodeId = $('#funnel-builder-canvas').flowchart('getSelectedOperatorId');
		var jobId = nodeId.split("_")[1];
		
		$('#modal_node_update').modal('show');
		
		var ajaxCall = $.ajax({
			method: "POST",
			data: {
				job_id: jobId,
				authenticity_token: csrf_token
			},
			dataType: "json",
			url: "/fbapi_read",
			cache: false,
			success: function (response) {
				console.log("AJAX READ Success");
				
				$('#node_update_job_id').val(response['job_id']);
				$('#node_update_job_name').val(response['name']);
				
				$('#node_update_email_list_id').val(response['email_list_id']);
				
				$('#node_update_job_subject').val(response['subject']);
				$('#node_update_job_content').val(response['content']);
				
				$('#node_update_hook_identifier').text(response['hook_identifier']);
				
				console.log('executed: ' + response['executed']);
				
				$('#node_update_job_executed').text(response['executed']);
				$('#node_update_job_execute_time').text(response['execute_time']);
				$('#node_update_job_execute_frequency').val(response['execute_frequency']);
				
				$('#node_update_app_id').text(response['app_id']);
				$('#node_update_campaign_id').text(response['client_campaign']);
				$('#node_update_local_identifier').text(response['local_identifier']);
				
				console.log('OperatorID: '.concat(nodeId));
			}
		});
		
	});
	
	// CREATE NODE
	$('#create_button').click(function (event) {
		
		$('#modal_node_create').modal('show');
		
		var ajaxCall = $.ajax({
			method: "POST",
			data: {
				app_id: <%= @app_id %>,
				campaign_id: <%= @campaign_id %>,
				authenticity_token: csrf_token
			},
			dataType: "json",
			url: "/fbapi_read",
			cache: false,
			success: function (response) {
				console.log("AJAX CREATE Success");
				
				$('#node_update_job_id').val(response['job_id']);
				$('#node_update_job_name').val(response['name']);
				
				$('#node_update_email_list_id').val(response['email_list_id']);
				
				$('#node_update_job_subject').val(response['subject']);
				$('#node_update_job_content').val(response['content']);
				
				$('#node_update_hook_identifier').text(response['hook_identifier']);
				
				console.log('executed: ' + response['executed']);
				
				$('#node_update_job_executed').text(response['executed']);
				$('#node_update_job_execute_time').text(response['execute_time']);
				$('#node_update_job_execute_frequency').val(response['execute_frequency']);
				
				$('#node_update_app_id').text(response['app_id']);
				$('#node_update_campaign_id').text(response['client_campaign']);
				$('#node_update_local_identifier').text(response['local_identifier']);
				
			}
		});
	});
	
	// CREATE NODE
	$('#create_button_submit').click(function (event) {
		
		var ajaxCall = $.ajax({
			method: "POST",
			data: {
				app_id: <%= @app_id %>,
				campaign_id: <%= @campaign_id %>,
				authenticity_token: csrf_token
			},
			dataType: "json",
			url: "/fbapi_create",
			cache: false,
			success: function (response) {
				console.log("AJAX CREATE Success");
				
				$('#node_update_job_id').val(response['job_id']);
				$('#node_update_job_name').val(response['name']);
				
				$('#node_update_email_list_id').val(response['email_list_id']);
				
				$('#node_update_job_subject').val(response['subject']);
				$('#node_update_job_content').val(response['content']);
				
				$('#node_update_hook_identifier').text(response['hook_identifier']);
				
				console.log('executed: ' + response['executed']);
				
				$('#node_update_job_executed').text(response['executed']);
				$('#node_update_job_execute_time').text(response['execute_time']);
				$('#node_update_job_execute_frequency').val(response['execute_frequency']);
				
				$('#node_update_app_id').text(response['app_id']);
				$('#node_update_campaign_id').text(response['client_campaign']);
				$('#node_update_local_identifier').text(response['local_identifier']);
				
			}
		});
	});
	
	// DELETE NODE
	$('#delete_selected_button').click(function () {
		
		var nodeId = $('#funnel-builder-canvas').flowchart('getSelectedOperatorId');
		var split = nodeId.split("_");
		var nodeType = split[0];
		var jobId = split[1];
		
		if(nodeType === 'campaign') {
			console.log("This is a campaign")
		}
		
		var ajaxCall = $.ajax({
			method: "POST",
			data: {
				job_id: jobId,
				authenticity_token: csrf_token
			},
			dataType: "json",
			url: "/fbapi_delete",
			cache: false,
			success: function (response) {
				console.log("AJAX DELETE Success");
			}
		});
		$canvas.flowchart('deleteSelected');
	});
	
	$canvas.siblings('.get_data').click(function () {
		var data = $canvas.flowchart('getData');
		$('#flowchart_data').val(JSON.stringify(flowchart_data, null, 2));
	});
	
	$('#node_delete_job_ok').click(function () {
		
	});
	
	function isJob() {
		var nodeId = $('#funnel-builder-canvas').flowchart('getSelectedOperatorId');
		var split = nodeId.split("_");
		var nodeType = split[0];
		var jobId = split[1];
		
		if(nodeType === 'job') {
			return true;
		}
	}
	
	function isCampaign() {
		var nodeId = $('#funnel-builder-canvas').flowchart('getSelectedOperatorId');
		var split = nodeId.split("_");
		var nodeType = split[0];
		var jobId = split[1];
		
		if(nodeType === 'campaign') {
			return true;
		}
	}
	
	
	//		// Apply the plugin on a standard, empty div...
	//		$('#funnel-builder-canvas').flowchart({
	//			onOperatorSelect: function (operatorId) {
	//				if(isJob()) {
	//					$('#delete_selected_button').show();
	//					$('#delete_selected_button').show();
	//				}
	//				return true;
	//			},
	//			onOperatorUnselect: function () {
	//				if(isJob()) {
	//					$('#delete_selected_button').hide();
	//					$('#delete_selected_button').hide();
	//				}
	//				return true;
	//			}
	//		});


</script>

<div class="modal fade" tabindex="-1" role="dialog" id="modal_node_delete" aria-labelledby="#modal_node_delete">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-header">
			<h4 class="modal-title" id="delete_job_label">Delete Job</h4>
		</div>
		<div class="modal-content">
			Job deleted succesfully!
			<span id="node_delete_job_id"></span>?
			<input type="btn btn-success" id="node_delete_job_ok" value="Ok"/>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modal_node_create" aria-labelledby="#modal_node_create">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">Create New Job</h4>
			</div>
			<div class="modal-body">
				<%#= render partial: "node_modal_form" %>
				<div id="node_form_partial">
					<form>
						<div class="form-group">
							<label for="job-name" class="control-label"><b>Name:</b></label>
							<input type="text" class="form-control" id="node_update_job_name" value="Enter a name for the job"/>
						</div>
						<b>Email Lists</b>
						<div class="form-group">
							<!--TODO: Choose a selected email-list dynamically-->
							<select id="node_update_email_list_id" class="form-control">
								<% first = true %>
								<% @lists.each do |el| %>
										<% if first %>
												<option><%= el.name %></option>
												<% first = false %>
										<% else %>
												<option><%= el.name %></option>
										<% end %>
								<% end %>
							</select>
						</div>
						<br>
						<div class="form-group">
							<b>Execute Frequency</b>
							<select id="node_update_job_execute_frequency" class="form-control">
								<option SELECTED>Execute Now</option>
								<option>Execute Once</option>
								<option>Execute Twice</option>
								<option>Execute Thrice</option>
							</select>
							<b>Execute-Time (24-hour)</b>
							<select id="node_job_execute_time" class="form-control">
								<% $x = 1 %>
								<% while $x <= 24 do %>
										<option> <%= $x.to_s %>:00</option>
										<% $x += 1 %>
								<% end %>
								<% $x = 1 %>
							</select>
						</div>
						<hr>
						<h5>Email</h5>
						<div class="form-group">
							<span class="input-group-addon">Subject</span>
							<input type="text" class="form-control" id="node_update_job_subject" value="">
						</div>
						<div class="form-group">
							<span class="input-group-addon">Content</span>
							<textarea class="form-control mediumEditable" rows=5 id="node_update_job_conent"></textarea>
						</div>
						<hr>
						<div class="list-group"> <!-- TODO: Dynamically fetch the value names from their ID's below -->
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Campaign ID: </h6>
							<span class="list-group-item-text" id="node_update_campaign_id"></span>
							</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Hook Identifier:</h6>
							<span class="list-group-item-text" id="node_update_hook_identifier"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">App ID:</h6>
							<span id="node_update_app_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Job ID:</h6>
							<span class="list-group-item-text" id="node_update_job_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Executed:</h6>
							<span class="list-group-item-text" id="node_update_job_executed"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Email List ID:</h6>
							<span class="list-group-item-text" id="node_update_email_list_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Job Local Identifier:</h6>
							<span class="list-group-item-text" id="node_update_local_identifier"></span>
						</span>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" id="new_job_submit" class="btn btn-primary">Create Job</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="modal_node_update" aria-labelledby="#modal_node_update">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">Update Job</h4>
			</div>
			<div class="modal-body">
				<%#= render partial: "node_modal_form" %>
				<div id="node_form_partial">
					<form>
						<div class="form-group">
							<label for="job-name" class="control-label"><b>Name:</b></label>
							<input type="text" class="form-control" id="node_update_job_name" value="Enter a name for the job"/>
						</div>
						<b>Email Lists</b>
						<div class="form-group">
							<!--TODO: Choose a selected email-list dynamically-->
							<select id="node_update_email_list_id" class="form-control">
								<% first = true %>
								<% @lists.each do |el| %>
										<% if first %>
												<option><%= el.name %></option>
												<% first = false %>
										<% else %>
												<option><%= el.name %></option>
										<% end %>
								<% end %>
							</select>
						</div>
						<br>
						<div class="form-group">
							<b>Execute Frequency</b>
							<select id="node_update_job_execute_frequency" class="form-control">
								<option SELECTED>Execute Now</option>
								<option>Execute Once</option>
								<option>Execute Twice</option>
								<option>Execute Thrice</option>
							</select>
							<b>Execute-Time (24-hour)</b>
							<select id="node_job_execute_time" class="form-control">
								<% $x = 1 %>
								<% while $x <= 24 do %>
										<option> <%= $x.to_s %>:00</option>
										<% $x += 1 %>
								<% end %>
								<% $x = 1 %>
							</select>
						</div>
						<hr>
						<h5>Email</h5>
						<div class="form-group">
							<span class="input-group-addon">Subject</span>
							<input type="text" class="form-control" id="node_update_job_subject" value="">
						</div>
						<div class="form-group">
							<span class="input-group-addon">Content</span>
							<textarea class="form-control mediumEditable" rows=5 id="node_update_job_conent"></textarea>
						</div>
						<hr>
						<div class="list-group"> <!-- TODO: Dynamically fetch the value names from their ID's below -->
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Campaign ID: </h6>
							<span class="list-group-item-text" id="node_update_campaign_id"></span>
							</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Hook Identifier:</h6>
							<span class="list-group-item-text" id="node_update_hook_identifier"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">App ID:</h6>
							<span id="node_update_app_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Job ID:</h6>
							<span class="list-group-item-text" id="node_update_job_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Executed:</h6>
							<span class="list-group-item-text" id="node_update_job_executed"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Email List ID:</h6>
							<span class="list-group-item-text" id="node_update_email_list_id"></span>
						</span>
							<span class="list-group-item">
							<h6 class="list-group-item-heading">Job Local Identifier:</h6>
							<span class="list-group-item-text" id="node_update_local_identifier"></span>
						</span>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" id="update_job_submit" class="btn btn-primary">Update Job</button>
				</div>
			</div>
		</div>
	</div>
</div>
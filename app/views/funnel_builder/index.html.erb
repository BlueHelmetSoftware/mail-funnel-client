<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"
      integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

<div class="container">
	<h2>Mail Funnel Builder</h2>
	<button class="btn btn-success create_operator" id="create_operator">New Job</button>
	<button class="btn btn-primary" id="save_funnel-builder">Save Rules</button>
	<button class="btn btn-danger" id="delete_selected_button">Delete Selected Job</button>
	<button class="btn btn-success" id="edit_selected_button">Edit Selected Job</button>
	
	<h2>Campaigns (Hooks)</h2>
	
	<div class="canvas-class" id="funnel-builder-canvas"></div>
</div>

<script type="text/javascript">
	$(document).ready(function () {
		console.log(<%=raw @json %>);
		
		var flowchart_data = <%=raw @json %>;
		
		var $canvas = $('#funnel-builder-canvas');
		$canvas.flowchart({
			data: flowchart_data
		});
		
		var windowHeight = $(window).height();   // Browser Viewport Height
		var docHeight = $(document).height(); // HTML Doc height
		var height = window.innerHeight;
		
		$canvas.height(docHeight);
		
		var operatorI = 0;
		$canvas.siblings('.create_operator').click(function () {
			var operatorId = 'created_operator_' + operatorI;
			var operatorData = {
				top: 60,
				left: 500,
				properties: {
					title: 'Operator ' + (operatorI + 3),
					inputs: {
						input_1: {
							label: 'Input 1',
						}
					},
					outputs: {
						output_1: {
							label: 'Output 1',
						}
					}
				}
			};
		});
		
		
		$('#submit_rules').click(function () {
		});
		
		$('#delete_selected_button').click(function () {
			$('#funnel-builder-canvas').flowchart('deleteSelected');
		});
		
		$('#edit_selected_button').click(function (event) {
			var operatorId = $('#funnel-builder-canvas').flowchart('getSelectedOperatorId');

//			event.preventDefault();
//			$.get(, function(html) {
//				$(html).appendTo('body').modal();
//			});
			$('#modal_'.concat(operatorId)).modal('show');
			
			console.log('OperatorID: '.concat(operatorId));
		});
		
		var operatorI = 0;
		$canvas.siblings('.create_operator').click(function () {
			var operatorId = 'created_job_' + operatorI;
			var operatorData = {
				top: 60,
				left: 500,
				properties: {
					title: 'New Job ' + (operatorI + 3),
					inputs: {
						input_1: {
							label: 'Previous Job',
						}
					},
					outputs: {
						output_1: {
							label: 'Next Job 1',
						}
					}
				}
			};
			
			operatorI++;
			
			$canvas.flowchart('createOperator', operatorId, operatorData);
		});
		
		$canvas.siblings('.delete_selected_button').click(function () {
			$canvas.flowchart('deleteSelected');
		});
		
		$canvas.siblings('.get_data').click(function () {
			var data = $canvas.flowchart('getData');
			$('#flowchart_data').val(JSON.stringify(flowchart_data, null, 2));
		});
		
		$canvas.siblings('.set_data').click(function () {
			var data = JSON.parse($('#flowchart_data').val());
			$canvas.flowchart('setData', flowchart_data);
		});
		
	});
</script>

<!--$(function() {-->
<!--// this initializes the dialog (and uses some common options that I do)-->
<!--$("#dialog").dialog({-->
<!--autoOpen : false, modal : true, show : "blind", hide : "blind"-->
<!--});-->

<div style="display:none" id="job_editors">
	<% @local_jobs.each do |job| %>
			<button type="button" class="btn btn-primary btn-sm" data-toggle="modal"
			        data-target="#modal_<%= job.local_identifier %>">
				Modal
			</button>
	<% end %>
</div>
<% @local_jobs.each do |job| %>
		<div class="modal fade" tabindex="-1" role="dialog" id="modal_<%= job.local_identifier %>"
		     aria-labelledby="#modal_<%= job.local_identifier %>">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">Modal title</h4>
					</div>
					<div class="modal-body">
						<form>
							<div class="form-group">
								<label for="recipient-name" class="control-label"><b>Name:</b></label>
								<input type="text" class="form-control" id="recipient-name" value="<%= job.name %>">
							</div>
							<b>Email Lists</b>
							<div class="form-group">
								<select class="form-control">
									<% first = true %>
									<% @email_lists.each do |el| %>
											<% if first %>
													<option><%= el.name %></option>
													<% first = false %>
											<% else %>
													<option><%= el.name %></option>
											<% end %>
									<% end %>
								</select>
							</div>
							<hr>
							<h5>Execute Time</h5>
							<div class="form-group">
								<b>Execute Frequency</b>
								<select class="form-control">
									<option>Execute Once</option>
									<option>Execute Twice</option>
									<option>Execute Thrice</option>
								</select>
								<b>Execute Day</b>
								<select class="form-control">
									<option>Next Ocurrence</option>
									<option>Second Ocurrence</option>
									<option>Third Ocurrence</option>
								</select>
								<b>Execute-Time</b>
								<select class="form-control">
									<% $x = 1 %>
									<% while $x <= 12 do %>
											<option> <%= $x.to_s %>:00 AM</option>
											<% $x += 1 %>
									<% end %>
									<% $x = 1 %>
									<% while $x <= 12 do %>
											<option> <%= $x.to_s %>:00 PM</option>
											<% $x += 1 %>
									<% end %>
								</select>
							</div>
							<hr>
							<h5>Email</h5>
							<div class="form-group">
								<span class="input-group-addon">Subject</span>
								<input type="text" class="form-control" id="recipient-name" value="<%= job.subject %>">
							</div>
							<div class="form-group">
								<span class="input-group-addon">Content</span>
								<textarea class="form-control mediumEditable" rows=5 id="message-text"><%= job.content %></textarea>
							</div>
							<hr>
							<div class="form-group">
								<b>Campaign:</b><%= Campaign.find(job.client_campaign).name %>
								<b>Hook:</b><%= HooksConstant.where(identifier: job.hook_identifier).first.name %>
								<b>App ID:</b><%= job.app_id %>
								<b>Executed:</b><%= job.executed %>
								<b>App ID:</b><%= job.app_id %>
								<b>Executed:</b><%= job.executed %>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary">Save changes</button>
					</div>
				</div>
			</div>
		</div>
		
		<!--job = Job.create(execute_frequency:   "execute_once",-->
		<!--execute_time:        "1330",-->
		<!--executed:            false,-->
		<!--subject:             Faker::Lorem.sentence,-->
		<!--content:             Faker::Lorem.paragraphs(3),-->
		<!--name:                Faker::Commerce.product_name,-->
		<!--app_id:              app.id,-->
		<!--campaign_identifier: c.hook_identifier,-->
		<!--hook_identifier:     c.hook_identifier,-->
		<!--client_campaign:     c.id,-->
		<!--email_list_id:       list.id-->

<% end %>